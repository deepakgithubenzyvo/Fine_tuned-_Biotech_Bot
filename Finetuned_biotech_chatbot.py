# -*- coding: utf-8 -*-
"""Untitled4.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1UuunYJxoVAOyWqtyeV10GBPLxA671CD3
"""

!pip install -q transformers datasets peft accelerate bitsandbytes sentencepiece

import torch
from transformers import (
    AutoTokenizer,
    AutoModelForCausalLM,
    TrainingArguments,
    Trainer
)
from peft import LoraConfig, get_peft_model
from datasets import load_dataset

import json

biotech_data = [

  {
    "instruction": "What is ATP binding in proteins?",
    "response": "ATP binding in proteins refers to the specific interaction of ATP with conserved nucleotide-binding sites such as P-loop or Rossmann fold motifs, enabling energy transfer or phosphate donation."
  },
  {
    "instruction": "Why do proteins bind ATP?",
    "response": "Proteins bind ATP to harness its chemical energy for driving biological processes such as catalysis, molecular transport, and signal transduction."
  },
  {
    "instruction": "Where does ATP bind in proteins?",
    "response": "ATP binds at specific binding pockets formed by conserved amino acid residues, often involving P-loop, Walker A/B, or Rossmann fold motifs."
  },
  {
    "instruction": "What motifs are involved in ATP binding?",
    "response": "Common ATP-binding motifs include the P-loop (Walker A), Walker B motif, and the Rossmann fold."
  },
  {
    "instruction": "What role does Mg2+ play in ATP binding?",
    "response": "Mg2+ stabilizes the negatively charged phosphate groups of ATP, facilitating proper binding and catalysis."
  },
  {
    "instruction": "Is ATP binding reversible?",
    "response": "Yes, ATP binding is typically reversible and regulated to allow controlled energy usage."
  },
  {
    "instruction": "Does ATP binding always lead to hydrolysis?",
    "response": "No, ATP binding may cause conformational changes without immediate hydrolysis, depending on protein function."
  },
  {
    "instruction": "How does ATP binding affect protein structure?",
    "response": "ATP binding often induces conformational changes that activate or regulate protein activity."
  },
  {
    "instruction": "What is the P-loop motif?",
    "response": "The P-loop is a conserved phosphate-binding loop that interacts with ATP phosphate groups in many ATP-binding proteins."
  },
  {
    "instruction": "What proteins commonly bind ATP?",
    "response": "Kinases, ATPases, motor proteins, and ABC transporters commonly bind ATP."
  },
  {
    "instruction": "What is ATP hydrolysis?",
    "response": "ATP hydrolysis is the enzymatic cleavage of ATP into ADP and inorganic phosphate, releasing energy."
  },
  {
    "instruction": "How is ATP binding different from ATP synthesis?",
    "response": "ATP binding involves ATP attaching to proteins, while ATP synthesis refers to ATP production from ADP and phosphate."
  },
  {
    "instruction": "Do all enzymes require ATP binding?",
    "response": "No, only enzymes involved in energy-dependent reactions require ATP binding."
  },
  {
    "instruction": "What is the Walker A motif?",
    "response": "Walker A is a conserved ATP-binding sequence involved in phosphate interaction."
  },
  {
    "instruction": "What is the Walker B motif?",
    "response": "Walker B coordinates Mg2+ and assists ATP hydrolysis."
  },
  {
    "instruction": "What happens after ATP binds to a kinase?",
    "response": "ATP donates a phosphate group to the substrate during phosphorylation."
  },
  {
    "instruction": "Is ATP binding specific?",
    "response": "Yes, ATP binding is highly specific and depends on precise structural complementarity."
  },
  {
    "instruction": "Can ATP bind without being hydrolyzed?",
    "response": "Yes, ATP can act as a regulatory ligand without hydrolysis."
  },
  {
    "instruction": "What is an ATPase?",
    "response": "An ATPase is an enzyme that hydrolyzes ATP to release energy."
  },
  {
    "instruction": "How does ATP binding power molecular motors?",
    "response": "ATP binding and hydrolysis induce conformational changes that generate mechanical force."
  },
  {
    "instruction": "What is an ABC transporter?",
    "response": "ABC transporters use ATP binding and hydrolysis to transport molecules across membranes."
  },
  {
    "instruction": "What residues interact with ATP?",
    "response": "Positively charged residues such as lysine and arginine stabilize ATP phosphates."
  },
  {
    "instruction": "Is ATP binding conserved evolutionarily?",
    "response": "Yes, ATP-binding motifs are highly conserved across species."
  },
  {
    "instruction": "Can ATP binding regulate gene expression?",
    "response": "Yes, ATP binding regulates transcription factors and chromatin remodelers."
  },
  {
    "instruction": "What is a nucleotide-binding domain?",
    "response": "It is a protein domain specialized for binding nucleotides such as ATP."
  },
  {
    "instruction": "Does ATP binding require oxygen?",
    "response": "No, ATP binding does not require molecular oxygen."
  },
  {
    "instruction": "What is the Rossmann fold?",
    "response": "The Rossmann fold is a structural motif that binds nucleotides like ATP or NAD."
  },
  {
    "instruction": "Is ATP binding involved in signaling?",
    "response": "Yes, ATP binding is essential for many signaling pathways."
  },
  {
    "instruction": "How does ATP binding affect enzyme kinetics?",
    "response": "ATP binding can increase reaction rates by providing energy or substrates."
  },
  {
    "instruction": "Is ATP binding transient?",
    "response": "Yes, ATP binding is usually transient and tightly regulated."
  },
  {
    "instruction": "What happens if ATP binding is disrupted?",
    "response": "Loss of ATP binding often leads to loss of protein function."
  },
  {
    "instruction": "Can mutations affect ATP binding?",
    "response": "Yes, mutations in ATP-binding motifs can impair binding and activity."
  },
  {
    "instruction": "Is ATP binding important in drug design?",
    "response": "Yes, many drugs target ATP-binding sites to inhibit protein function."
  },
  {
    "instruction": "Do structural proteins bind ATP?",
    "response": "Most structural proteins do not bind ATP."
  },
  {
    "instruction": "What is ATP-dependent catalysis?",
    "response": "It refers to reactions that require ATP binding and hydrolysis to proceed."
  },
  {
    "instruction": "How is ATP binding studied experimentally?",
    "response": "ATP binding is studied using crystallography, NMR, and binding assays."
  },
  {
    "instruction": "Why is ATP called the energy currency?",
    "response": "ATP stores and transfers energy through phosphate bonds."
  },
  {
    "instruction": "Does ATP binding alter protein flexibility?",
    "response": "Yes, ATP binding often increases or restricts protein flexibility."
  }



]
with open("biotech_train.json", "w") as f:
    json.dump(biotech_data, f, indent=2)

dataset = load_dataset("json", data_files="biotech_train.json")

def format_prompt(example):
    text = f"""### Instruction:
{example['instruction']}

### Response:
{example['response']}"""
    return {"text": text}

dataset = dataset.map(format_prompt)

model_name = "TinyLlama/TinyLlama-1.1B-Chat-v1.0"

tokenizer = AutoTokenizer.from_pretrained(model_name)
tokenizer.pad_token = tokenizer.eos_token

model = AutoModelForCausalLM.from_pretrained(
    model_name,
    load_in_4bit=True,
    device_map="auto"
)

lora_config = LoraConfig(
    r=8,
    lora_alpha=16,
    target_modules=["q_proj", "v_proj"],
    lora_dropout=0.05,
    bias="none",
    task_type="CAUSAL_LM"
)

model = get_peft_model(model, lora_config)
model.print_trainable_parameters()

def tokenize(example):
    return tokenizer(
        example["text"],
        truncation=True,
        padding="max_length",
        max_length=256
    )

tokenized_ds = dataset["train"].map(tokenize, remove_columns=dataset["train"].column_names)

training_args = TrainingArguments(
    output_dir="./biotech_chatbot",
    per_device_train_batch_size=2,
    gradient_accumulation_steps=4,
    learning_rate=2e-4,
    num_train_epochs=5,
    logging_steps=10,
    save_strategy="epoch",
    fp16=True,
    optim="paged_adamw_8bit"
)

tokenized_ds = tokenized_ds.map(lambda examples: {"labels": examples["input_ids"]}, batched=True)

trainer = Trainer(
    model=model,
    train_dataset=tokenized_ds,
    args=training_args,
    tokenizer=tokenizer
)

trainer.train()

def biotech_chat(question):
    prompt = f"""### Instruction:
{question}

### Response:"""

    inputs = tokenizer(prompt, return_tensors="pt").to("cuda")

    outputs = model.generate(
        **inputs,
        max_new_tokens=150,
        do_sample=True,
        temperature=0.7
    )

    return tokenizer.decode(outputs[0], skip_special_tokens=True)

# Test
print(biotech_chat("What is ATP binding in proteins?"))